<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character.AI OpenAI Proxy - –¢–µ—Å—Ç–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .tabs {
            display: flex;
            background: #f5f5f7;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: white;
            color: #667eea;
            font-weight: 600;
            border-bottom: 2px solid #667eea;
        }
        
        .content {
            padding: 30px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .info-box {
            background: #f5f5f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 16px;
        }
        
        .info-box p, .info-box li {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .info-box ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        .response-box {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .response-box h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 20%;
            text-align: right;
        }
        
        .message.assistant {
            background: white;
            border: 1px solid #e0e0e0;
            margin-right: 20%;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .endpoint-url {
            background: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #667eea;
            margin-top: 10px;
            word-break: break-all;
            font-family: monospace;
            color: #667eea;
        }

        /* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .history-controls button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Character.AI OpenAI Proxy</h1>
            <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Character.AI —á–µ—Ä–µ–∑ OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API –≤ Risu AI</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('instructions')">üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</button>
            <button class="tab" onclick="switchTab('token')">üîë –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω</button>
            <button class="tab" onclick="switchTab('test')">üß™ –¢–µ—Å—Ç–µ—Ä API</button>
        </div>

        <div class="content">
            <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
            <div id="instructions" class="tab-content active">
                <div class="info-box">
                    <h3>üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –¥–ª—è Risu AI</h3>
                    <ol>
                        <li>–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω Character.AI –≤–æ –≤–∫–ª–∞–¥–∫–µ "–ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω"</li>
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ Risu AI –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ "Custom" –≤ –∫–∞—á–µ—Å—Ç–≤–µ API –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</li>
                        <li>–í–≤–µ–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:</li>
                    </ol>
                    <div class="endpoint-url" id="apiUrl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>

                <div class="info-box">
                    <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Risu AI</h3>
                    <ul>
                        <li><strong>API URL:</strong> <span class="code-inline">https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/v1/chat/completions</span></li>
                        <li><strong>API Key:</strong> –í–∞—à —Ç–æ–∫–µ–Ω Character.AI</li>
                        <li><strong>Model:</strong> ID –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: <span class="code-inline">YntB_1e8Prw3QOMpj0lOXQ</span>)</li>
                        <li><strong>Streaming:</strong> –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚úÖ</li>
                    </ul>
                </div>

                <div class="info-box">
                    <h3>üìù –§–æ—Ä–º–∞—Ç –º–æ–¥–µ–ª–∏</h3>
                    <p>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–∑ —Ñ–æ—Ä–º–∞—Ç–æ–≤:</p>
                    <ul>
                        <li><strong>–ù–æ–≤—ã–π —á–∞—Ç:</strong> <span class="code-inline">CHARACTER_ID</span></li>
                        <li><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —á–∞—Ç:</strong> <span class="code-inline">CHARACTER_ID:CHAT_ID</span></li>
                    </ul>
                    <p style="margin-top: 10px;">–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∏–∞–ª–æ–≥–∏ –º–µ–∂–¥—É Character.AI –∏ Risu AI!</p>
                </div>

                <div class="info-box">
                    <h3>üîç –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å Character ID</h3>
                    <ol>
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ —á–∞—Ç —Å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º –Ω–∞ character.ai</li>
                        <li>–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã</li>
                        <li>–ù–∞–π–¥–∏—Ç–µ ID –ø–æ—Å–ª–µ <span class="code-inline">char=</span></li>
                    </ol>
                    <p style="margin-top: 10px;"><strong>–ü—Ä–∏–º–µ—Ä URL:</strong></p>
                    <div class="code-block">https://character.ai/chat?char=YntB_1e8Prw3QOMpj0lOXQ</div>
                </div>
            </div>

            <!-- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ -->
            <div id="token" class="tab-content">
                <div class="info-box">
                    <h3>üîê –°–ø–æ—Å–æ–± 1: –ü–æ–ª—É—á–∏—Ç—å –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)</h3>
                    <ol>
                        <li>–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ <a href="https://character.ai" target="_blank">character.ai</a></li>
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12)</li>
                        <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤–æ –≤–∫–ª–∞–¥–∫—É "Application" ‚Üí "Local Storage"</li>
                        <li>–ù–∞–π–¥–∏—Ç–µ –∫–ª—é—á <span class="code-inline">@@auth0spajs@@::dyD3gE281MqgISG7FuIXYhL2WEknqZzv::https://auth0.character.ai/::openid profile email offline_access</span></li>
                        <li>–û—Ç–∫—Ä–æ–π—Ç–µ body –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ <span class="code-inline">access_token</span></li>
                    </ol>
                </div>

                <div class="info-box">
                    <h3>‚úâÔ∏è –°–ø–æ—Å–æ–± 2: –ü–æ–ª—É—á–∏—Ç—å –ø–æ email</h3>
                    <div class="form-group">
                        <label for="email">Email –∞–¥—Ä–µ—Å</label>
                        <input type="email" id="email" placeholder="your@email.com">
                    </div>
                    <button onclick="generateToken()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏</button>
                    <div id="tokenStatus"></div>
                </div>

                <div class="info-box" style="background: #fff3cd; border: 1px solid #ffc107;">
                    <h3>‚ö†Ô∏è –í–∞–∂–Ω–æ</h3>
                    <ul>
                        <li>–¢–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 1 –≥–æ–¥–∞</li>
                        <li>–ù–µ –¥–µ–ª–∏—Ç–µ—Å—å —Ç–æ–∫–µ–Ω–æ–º —Å —Ç—Ä–µ—Ç—å–∏–º–∏ –ª–∏—Ü–∞–º–∏</li>
                        <li>–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ email-–º–µ—Ç–æ–¥–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É —Å–ø–∞–º</li>
                    </ul>
                </div>
            </div>

            <!-- –¢–µ—Å—Ç–µ—Ä -->
            <div id="test" class="tab-content">
                <div class="form-group">
                    <label for="testToken">API Token (Character.AI)</label>
                    <input type="password" id="testToken" placeholder="–í–∞—à —Ç–æ–∫–µ–Ω Character.AI">
                </div>

                <div class="form-group">
                    <label for="testCharacterId">Character ID</label>
                    <input type="text" id="testCharacterId" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: YntB_1e8Prw3QOMpj0lOXQ">
                </div>

                <div class="form-group">
                    <label for="testChatId">Chat ID (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞)</label>
                    <input type="text" id="testChatId" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞">
                </div>

                <div class="form-group">
                    <label for="testMessage">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                    <textarea id="testMessage" rows="3" placeholder="–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"></textarea>
                </div>

                <button onclick="testAPI()">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
                
                <div class="history-controls">
                    <button onclick="clearHistory()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                    <button onclick="saveHistory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                    <button onclick="loadHistory()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
                </div>

                <div id="testResponse" class="response-box" style="display: none;">
                    <h3>üí¨ –î–∏–∞–ª–æ–≥</h3>
                    <div id="messages"></div>
                </div>

                <div id="testStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ URL endpoint
        window.addEventListener('DOMContentLoaded', () => {
            const apiUrl = window.location.origin + '/v1/chat/completions';
            document.getElementById('apiUrl').textContent = apiUrl;
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
        async function generateToken() {
            const email = document.getElementById('email').value;
            const statusDiv = document.getElementById('tokenStatus');
            
            if (!email) {
                statusDiv.innerHTML = '<div class="status error">–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="status info">–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...</div>';
            
            try {
                const response = await fetch('/api/auth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, timeout: 120 })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à—É –ø–æ—á—Ç—É!<br>
                            –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –≤ –ø–∏—Å—å–º–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞.
                            ${data.token ? `<br><strong>–¢–æ–∫–µ–Ω:</strong> ${data.token}` : ''}
                        </div>
                    `;
                    
                    if (data.token) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ
                        localStorage.setItem('cai_token', data.token);
                    }
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå ${data.error || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞'}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API
        async function testAPI() {
            const token = document.getElementById('testToken').value;
            const characterId = document.getElementById('testCharacterId').value;
            const chatId = document.getElementById('testChatId').value;
            const message = document.getElementById('testMessage').value;
            const statusDiv = document.getElementById('testStatus');
            const responseDiv = document.getElementById('testResponse');
            const messagesDiv = document.getElementById('messages');
            
            if (!token || !characterId || !message) {
                statusDiv.innerHTML = '<div class="status error">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è</div>';
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
            responseDiv.style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            messagesDiv.innerHTML += `<div class="message user">${message}</div>`;
            
            statusDiv.innerHTML = '<div class="status info">‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è...</div>';
            
            try {
                const model = chatId ? `${characterId}:${chatId}` : characterId;
                const apiUrl = window.location.origin + '/v1/chat/completions';
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'user', content: message }
                        ],
                        stream: false
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const assistantMessage = data.choices[0].message.content;
                    messagesDiv.innerHTML += `<div class="message assistant">${assistantMessage}</div>`;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º chat_id –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                    const modelInfo = data.model.split(':');
                    if (modelInfo[1] && !document.getElementById('testChatId').value) {
                        document.getElementById('testChatId').value = modelInfo[1];
                    }
                    
                    statusDiv.innerHTML = `
                        <div class="status success">
                            ‚úÖ –£—Å–ø–µ—à–Ω–æ!<br>
                            Model: ${data.model}<br>
                            Tokens: ${data.usage.total_tokens}
                        </div>
                    `;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    saveToLocalStorage(characterId, chatId || modelInfo[1], message, assistantMessage);
                } else {
                    statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${data.error}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('testMessage').value = '';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
        function saveToLocalStorage(characterId, chatId, userMessage, assistantMessage) {
            const key = `cai_history_${characterId}`;
            let history = JSON.parse(localStorage.getItem(key) || '[]');
            
            history.push({
                chatId,
                timestamp: Date.now(),
                user: userMessage,
                assistant: assistantMessage
            });
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 100 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
            if (history.length > 100) {
                history = history.slice(-100);
            }
            
            localStorage.setItem(key, JSON.stringify(history));
        }

        // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        function clearHistory() {
            document.getElementById('messages').innerHTML = '';
            document.getElementById('testChatId').value = '';
            document.getElementById('testResponse').style.display = 'none';
            document.getElementById('testStatus').innerHTML = '<div class="status info">–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞</div>';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        function saveHistory() {
            const characterId = document.getElementById('testCharacterId').value;
            if (!characterId) {
                alert('–í–≤–µ–¥–∏—Ç–µ Character ID');
                return;
            }
            
            const key = `cai_history_${characterId}`;
            const history = localStorage.getItem(key);
            
            if (history) {
                const blob = new Blob([history], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `character_${characterId}_history.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert('–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        function loadHistory() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const text = await file.text();
                    const history = JSON.parse(text);
                    const messagesDiv = document.getElementById('messages');
                    
                    messagesDiv.innerHTML = '';
                    history.forEach(item => {
                        messagesDiv.innerHTML += `
                            <div class="message user">${item.user}</div>
                            <div class="message assistant">${item.assistant}</div>
                        `;
                    });
                    
                    document.getElementById('testResponse').style.display = 'block';
                    
                    if (history.length > 0) {
                        const lastItem = history[history.length - 1];
                        document.getElementById('testChatId').value = lastItem.chatId || '';
                    }
                }
            };
            input.click();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('cai_token');
            if (savedToken) {
                document.getElementById('testToken').value = savedToken;
            }
        });
    </script>
</body>
</html>
